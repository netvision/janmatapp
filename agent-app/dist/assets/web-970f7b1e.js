import{r as he,C as pe,F,W as ve}from"./Survey-e3f93267.js";import"./index-ace43089.js";import"./vendor-740be9e2.js";import"./utils-917b1704.js";const M={RECORDING:"RECORDING",PAUSED:"PAUSED",NONE:"NONE"},ge=he("BlobWriter");function me(u){return window.btoa(Array.from(new Uint8Array(u)).map(function(o){return String.fromCharCode(o)}).join(""))}function Re({path:u,directory:o,blob:a,recursive:p}){return F.writeFile({directory:o,path:u,recursive:p,data:""}).then(function(){return new Promise(function(d,l){function c(s){l(s.target.error)}const h=window.indexedDB.open("Disc");h.onerror=c,h.onsuccess=function(){const m=h.result.transaction("FileStorage","readwrite");m.onerror=c;const v=m.objectStore("FileStorage"),g=`/${o}/${u.replace(/^\//,"")}`,_=v.get(g);_.onsuccess=function(){_.result.size=a.size,_.result.content=a;const P=v.put(_.result);P.onsuccess=function(){d(void 0)}}}})})}function re({path:u,directory:o,blob:a,recursive:p}){return F.writeFile({directory:o,path:u,recursive:p,data:""}).then(function d(){if(a.size===0)return Promise.resolve();const l=3*128*1024,c=a.slice(0,l);return a=a.slice(l),new Response(c).arrayBuffer().then(function(s){return F.appendFile({directory:o,path:u,data:me(s)})}).then(d)})}function we(u){const{path:o,directory:a,blob:p,fast_mode:d=!1,recursive:l,on_fallback:c}=u;return!p||!Number.isSafeInteger(p.size)||typeof p.type!="string"?Promise.reject(new Error("Not a Blob.")):pe.getPlatform()==="web"?d?Re(u):re(u):Promise.all([ge.get_config(),F.getUri({path:o,directory:a})]).then(function([h,s]){const m=s.uri.replace("file://","");return(window.CapacitorWebFetch||window.fetch)(h.base_url+m+(l?"?recursive=true":""),{headers:{authorization:h.auth_token},method:"put",body:p}).then(function(g){if(g.status!==204)throw new Error("Bad HTTP status: "+g.status);return s.uri})}).catch(function(s){return c!==void 0&&c(s),re(u)})}const ye=Object.freeze(we);function Ee(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var ce={};function _e(u){return u&&u.__esModule?u:{default:u}}var be=_e,Y={exports:{}},te;function Se(){return te||(te=1,function(u){var o=function(a){var p=Object.prototype,d=p.hasOwnProperty,l=Object.defineProperty||function(r,e,t){r[e]=t.value},c,h=typeof Symbol=="function"?Symbol:{},s=h.iterator||"@@iterator",m=h.asyncIterator||"@@asyncIterator",v=h.toStringTag||"@@toStringTag";function g(r,e,t){return Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}),r[e]}try{g({},"")}catch{g=function(e,t,i){return e[t]=i}}function _(r,e,t,i){var n=e&&e.prototype instanceof j?e:j,f=Object.create(n.prototype),R=new $(i||[]);return l(f,"_invoke",{value:le(r,t,R)}),f}a.wrap=_;function P(r,e,t){try{return{type:"normal",arg:r.call(e,t)}}catch(i){return{type:"throw",arg:i}}}var J="suspendedStart",de="suspendedYield",K="executing",G="completed",b={};function j(){}function A(){}function T(){}var q={};g(q,s,function(){return this});var B=Object.getPrototypeOf,C=B&&B(B(z([])));C&&C!==p&&d.call(C,s)&&(q=C);var N=T.prototype=j.prototype=Object.create(q);A.prototype=T,l(N,"constructor",{value:T,configurable:!0}),l(T,"constructor",{value:A,configurable:!0}),A.displayName=g(T,v,"GeneratorFunction");function Z(r){["next","throw","return"].forEach(function(e){g(r,e,function(t){return this._invoke(e,t)})})}a.isGeneratorFunction=function(r){var e=typeof r=="function"&&r.constructor;return e?e===A||(e.displayName||e.name)==="GeneratorFunction":!1},a.mark=function(r){return Object.setPrototypeOf?Object.setPrototypeOf(r,T):(r.__proto__=T,g(r,v,"GeneratorFunction")),r.prototype=Object.create(N),r},a.awrap=function(r){return{__await:r}};function k(r,e){function t(f,R,w,E){var y=P(r[f],r,R);if(y.type==="throw")E(y.arg);else{var W=y.arg,I=W.value;return I&&typeof I=="object"&&d.call(I,"__await")?e.resolve(I.__await).then(function(D){t("next",D,w,E)},function(D){t("throw",D,w,E)}):e.resolve(I).then(function(D){W.value=D,w(W)},function(D){return t("throw",D,w,E)})}}var i;function n(f,R){function w(){return new e(function(E,y){t(f,R,E,y)})}return i=i?i.then(w,w):w()}l(this,"_invoke",{value:n})}Z(k.prototype),g(k.prototype,m,function(){return this}),a.AsyncIterator=k,a.async=function(r,e,t,i,n){n===void 0&&(n=Promise);var f=new k(_(r,e,t,i),n);return a.isGeneratorFunction(e)?f:f.next().then(function(R){return R.done?R.value:f.next()})};function le(r,e,t){var i=J;return function(f,R){if(i===K)throw new Error("Generator is already running");if(i===G){if(f==="throw")throw R;return ee()}for(t.method=f,t.arg=R;;){var w=t.delegate;if(w){var E=x(w,t);if(E){if(E===b)continue;return E}}if(t.method==="next")t.sent=t._sent=t.arg;else if(t.method==="throw"){if(i===J)throw i=G,t.arg;t.dispatchException(t.arg)}else t.method==="return"&&t.abrupt("return",t.arg);i=K;var y=P(r,e,t);if(y.type==="normal"){if(i=t.done?G:de,y.arg===b)continue;return{value:y.arg,done:t.done}}else y.type==="throw"&&(i=G,t.method="throw",t.arg=y.arg)}}}function x(r,e){var t=e.method,i=r.iterator[t];if(i===c)return e.delegate=null,t==="throw"&&r.iterator.return&&(e.method="return",e.arg=c,x(r,e),e.method==="throw")||t!=="return"&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+t+"' method")),b;var n=P(i,r.iterator,e.arg);if(n.type==="throw")return e.method="throw",e.arg=n.arg,e.delegate=null,b;var f=n.arg;if(!f)return e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,b;if(f.done)e[r.resultName]=f.value,e.next=r.nextLoc,e.method!=="return"&&(e.method="next",e.arg=c);else return f;return e.delegate=null,b}Z(N),g(N,v,"Generator"),g(N,s,function(){return this}),g(N,"toString",function(){return"[object Generator]"});function fe(r){var e={tryLoc:r[0]};1 in r&&(e.catchLoc=r[1]),2 in r&&(e.finallyLoc=r[2],e.afterLoc=r[3]),this.tryEntries.push(e)}function U(r){var e=r.completion||{};e.type="normal",delete e.arg,r.completion=e}function $(r){this.tryEntries=[{tryLoc:"root"}],r.forEach(fe,this),this.reset(!0)}a.keys=function(r){var e=Object(r),t=[];for(var i in e)t.push(i);return t.reverse(),function n(){for(;t.length;){var f=t.pop();if(f in e)return n.value=f,n.done=!1,n}return n.done=!0,n}};function z(r){if(r){var e=r[s];if(e)return e.call(r);if(typeof r.next=="function")return r;if(!isNaN(r.length)){var t=-1,i=function n(){for(;++t<r.length;)if(d.call(r,t))return n.value=r[t],n.done=!1,n;return n.value=c,n.done=!0,n};return i.next=i}}return{next:ee}}a.values=z;function ee(){return{value:c,done:!0}}return $.prototype={constructor:$,reset:function(r){if(this.prev=0,this.next=0,this.sent=this._sent=c,this.done=!1,this.delegate=null,this.method="next",this.arg=c,this.tryEntries.forEach(U),!r)for(var e in this)e.charAt(0)==="t"&&d.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=c)},stop:function(){this.done=!0;var r=this.tryEntries[0],e=r.completion;if(e.type==="throw")throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var e=this;function t(E,y){return f.type="throw",f.arg=r,e.next=E,y&&(e.method="next",e.arg=c),!!y}for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i],f=n.completion;if(n.tryLoc==="root")return t("end");if(n.tryLoc<=this.prev){var R=d.call(n,"catchLoc"),w=d.call(n,"finallyLoc");if(R&&w){if(this.prev<n.catchLoc)return t(n.catchLoc,!0);if(this.prev<n.finallyLoc)return t(n.finallyLoc)}else if(R){if(this.prev<n.catchLoc)return t(n.catchLoc,!0)}else if(w){if(this.prev<n.finallyLoc)return t(n.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(r,e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc<=this.prev&&d.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}n&&(r==="break"||r==="continue")&&n.tryLoc<=e&&e<=n.finallyLoc&&(n=null);var f=n?n.completion:{};return f.type=r,f.arg=e,n?(this.method="next",this.next=n.finallyLoc,b):this.complete(f)},complete:function(r,e){if(r.type==="throw")throw r.arg;return r.type==="break"||r.type==="continue"?this.next=r.arg:r.type==="return"?(this.rval=this.arg=r.arg,this.method="return",this.next="end"):r.type==="normal"&&e&&(this.next=e),b},finish:function(r){for(var e=this.tryEntries.length-1;e>=0;--e){var t=this.tryEntries[e];if(t.finallyLoc===r)return this.complete(t.completion,t.afterLoc),U(t),b}},catch:function(r){for(var e=this.tryEntries.length-1;e>=0;--e){var t=this.tryEntries[e];if(t.tryLoc===r){var i=t.completion;if(i.type==="throw"){var n=i.arg;U(t)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(r,e,t){return this.delegate={iterator:z(r),resultName:e,nextLoc:t},this.method==="next"&&(this.arg=c),b}},a}(u.exports);try{regeneratorRuntime=o}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=o:Function("r","regeneratorRuntime = r")(o)}}(Y)),Y.exports}var H,ne;function Pe(){return ne||(ne=1,H=Se()),H}var V,oe;function Oe(){if(oe)return V;oe=1;function u(a,p,d,l,c,h,s){try{var m=a[h](s),v=m.value}catch(g){d(g);return}m.done?p(v):Promise.resolve(v).then(l,c)}function o(a){return function(){var p=this,d=arguments;return new Promise(function(l,c){var h=a.apply(p,d);function s(v){u(h,l,c,s,m,"next",v)}function m(v){u(h,l,c,s,m,"throw",v)}s(void 0)})}}return V=o,V}(function(u){var o=be;Object.defineProperty(u,"__esModule",{value:!0}),u.default=d;var a=o(Pe()),p=o(Oe());function d(c){return l.apply(this,arguments)}function l(){return(l=(0,p.default)(a.default.mark(function c(h){var s,m;return a.default.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return s=document.createElement("video"),m=new Promise(function(g,_){s.addEventListener("loadedmetadata",function(){s.duration===1/0?(s.currentTime=Number.MAX_SAFE_INTEGER,s.ontimeupdate=function(){s.ontimeupdate=null,g(s.duration),s.currentTime=0}):g(s.duration)}),s.onerror=function(P){return _(P.target.error)}}),s.src=typeof h=="string"||h instanceof String?h:window.URL.createObjectURL(h),v.abrupt("return",m);case 4:case"end":return v.stop()}},c)}))).apply(this,arguments)}})(ce);const Te=Ee(ce),O=()=>({value:!0}),L=()=>({value:!1}),De=()=>new Error("MISSING_PERMISSION"),Ne=()=>new Error("ALREADY_RECORDING"),Ie=()=>new Error("DEVICE_CANNOT_VOICE_RECORD"),ie=()=>new Error("FAILED_TO_RECORD"),Le=()=>new Error("EMPTY_RECORDING"),Q=()=>new Error("RECORDING_HAS_NOT_STARTED"),ae=()=>new Error("FAILED_TO_FETCH_RECORDING"),X=()=>new Error("COULD_NOT_QUERY_PERMISSION_STATUS"),se={"audio/aac":".aac","audio/mp4":".mp3","audio/webm;codecs=opus":".ogg","audio/webm":".ogg","audio/ogg;codecs=opus":".ogg"},ue=()=>new Promise(()=>{});class S{constructor(){this.mediaRecorder=null,this.chunks=[],this.pendingResult=ue()}static async canDeviceVoiceRecord(){var o;return((o=navigator==null?void 0:navigator.mediaDevices)===null||o===void 0?void 0:o.getUserMedia)==null||S.getSupportedMimeType()==null?L():O()}async startRecording(o){if(this.mediaRecorder!=null)throw Ne();if(!(await S.canDeviceVoiceRecord()).value)throw Ie();if(!(await S.hasAudioRecordingPermission().catch(()=>O())).value)throw De();return navigator.mediaDevices.getUserMedia({audio:!0}).then(d=>this.onSuccessfullyStartedRecording(d,o)).catch(this.onFailedToStartRecording.bind(this))}async stopRecording(){if(this.mediaRecorder==null)throw Q();try{return this.mediaRecorder.stop(),this.mediaRecorder.stream.getTracks().forEach(o=>o.stop()),this.pendingResult}catch{throw ae()}finally{this.prepareInstanceForNextOperation()}}static async hasAudioRecordingPermission(){return navigator.permissions.query==null?navigator.mediaDevices==null?Promise.reject(X()):navigator.mediaDevices.getUserMedia({audio:!0}).then(()=>O()).catch(()=>{throw X()}):navigator.permissions.query({name:"microphone"}).then(o=>({value:o.state==="granted"})).catch(()=>{throw X()})}static async requestAudioRecordingPermission(){return(await S.hasAudioRecordingPermission().catch(()=>L())).value?O():navigator.mediaDevices.getUserMedia({audio:!0}).then(()=>O()).catch(()=>L())}pauseRecording(){if(this.mediaRecorder==null)throw Q();return this.mediaRecorder.state==="recording"?(this.mediaRecorder.pause(),Promise.resolve(O())):Promise.resolve(L())}resumeRecording(){if(this.mediaRecorder==null)throw Q();return this.mediaRecorder.state==="paused"?(this.mediaRecorder.resume(),Promise.resolve(O())):Promise.resolve(L())}getCurrentStatus(){return this.mediaRecorder==null?Promise.resolve({status:M.NONE}):this.mediaRecorder.state==="recording"?Promise.resolve({status:M.RECORDING}):this.mediaRecorder.state==="paused"?Promise.resolve({status:M.PAUSED}):Promise.resolve({status:M.NONE})}static getSupportedMimeType(){if((MediaRecorder==null?void 0:MediaRecorder.isTypeSupported)==null)return null;const o=Object.keys(se).find(a=>MediaRecorder.isTypeSupported(a));return o??null}onSuccessfullyStartedRecording(o,a){return this.pendingResult=new Promise((p,d)=>{this.mediaRecorder=new MediaRecorder(o),this.mediaRecorder.onerror=()=>{this.prepareInstanceForNextOperation(),d(ie())},this.mediaRecorder.onstop=async()=>{var l,c,h;const s=S.getSupportedMimeType();if(s==null){this.prepareInstanceForNextOperation(),d(ae());return}const m=new Blob(this.chunks,{type:s});if(m.size<=0){this.prepareInstanceForNextOperation(),d(Le());return}let v,g;a!=null?(v=`${(h=(c=(l=a.subDirectory)===null||l===void 0?void 0:l.match(/^\/?(.+[^/])\/?$/))===null||c===void 0?void 0:c[1])!==null&&h!==void 0?h:""}/recording-${new Date().getTime()}${se[s]}`,await ye({blob:m,directory:a.directory,fast_mode:!0,path:v,recursive:!0})):g=await S.blobToBase64(m);const _=await Te(m);this.prepareInstanceForNextOperation(),p({value:{recordDataBase64:g,mimeType:s,msDuration:_*1e3,path:v}})},this.mediaRecorder.ondataavailable=l=>this.chunks.push(l.data),this.mediaRecorder.start()}),O()}onFailedToStartRecording(){throw this.prepareInstanceForNextOperation(),ie()}static blobToBase64(o){return new Promise(a=>{const p=new FileReader;p.onloadend=()=>{const d=String(p.result),l=d.split("base64,"),c=l.length>1?l[1]:d;a(c.trim())},p.readAsDataURL(o)})}prepareInstanceForNextOperation(){if(this.mediaRecorder!=null&&this.mediaRecorder.state==="recording")try{this.mediaRecorder.stop()}catch(o){console.warn("While trying to stop a media recorder, an error was thrown",o)}this.pendingResult=ue(),this.mediaRecorder=null,this.chunks=[]}}class Me extends ve{constructor(){super(...arguments),this.voiceRecorderInstance=new S}canDeviceVoiceRecord(){return S.canDeviceVoiceRecord()}hasAudioRecordingPermission(){return S.hasAudioRecordingPermission()}requestAudioRecordingPermission(){return S.requestAudioRecordingPermission()}startRecording(o){return this.voiceRecorderInstance.startRecording(o)}stopRecording(){return this.voiceRecorderInstance.stopRecording()}pauseRecording(){return this.voiceRecorderInstance.pauseRecording()}resumeRecording(){return this.voiceRecorderInstance.resumeRecording()}getCurrentStatus(){return this.voiceRecorderInstance.getCurrentStatus()}}export{Me as VoiceRecorderWeb};
